<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Bói Dịch - Lập Quẻ Kinh Dịch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #f8f4e9;
            color: #3a3226;
        }
        
        .hexagram-container {
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            margin: 20px auto;
            width: 60px;
        }
        
        .hexagram-horizontal {
            display: flex;
            flex-direction: column-reverse;
            gap: 8px;
        }
        
        .hexagram-line {
            height: 10px;
            position: relative;
        }
        
        .yin-line {
            display: flex;
            justify-content: space-around;
/*            background-color: #3b82f6; /* Màu xanh cho hào âm */*/
        }
        
        .yang-line {
            background-color: #ef4444; /* Màu đỏ cho hào dương */
        }

        .yin-line, .yang-line {
            height: 10px;
        }

        .yin-line:before, .yin-line:after {
            content: '';
            height: 10px;
            width: 45%;
            background-color: #3b82f6;
        }
        
        .hexagram-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #7b341e;
        }
        
        .fade-in {
            animation: fadeIn 1.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .coin {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .coin-heads {
            background-color: #f59e0b;
            color: white;
        }
        
        .coin-tails {
            background-color: #4b5563;
            color: white;
        }
        
        .tossing {
            animation: toss 0.5s infinite;
        }
        
        @keyframes toss {
            0% { transform: rotate(0deg) translateY(0); }
            50% { transform: rotate(180deg) translateY(-20px); }
            100% { transform: rotate(360deg) translateY(0); }
        }
        
        .method-tab {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }
        
        .method-tab.active {
            background-color: #f59e0b;
            color: white;
            font-weight: bold;
        }
        
        .method-content {
            display: none;
        }
        
        .method-content.active {
            display: block;
        }
        
        .plum-blossom-input {
            width: 60px;
            text-align: center;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin: 0 5px;
        }
        
        .moving-line {
            position: relative;
        }
        
        .moving-line::after {
            content: '●';
            position: absolute;
            color: #ef4444;
            font-size: 12px;
            left: -16px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .hexagram-row {
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .hexagram-row {
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 40px;
            }
            
            .hexagram-box {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-amber-800 mb-2">KINH DỊCH BÁT QUÁI</h1>
            <p class="text-lg text-gray-700">Ứng dụng lập quẻ bói dịch - Gieo quẻ, luận đoán và nhận lời khuyên</p>
        </header>
        
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex border-b mb-6">
                <div class="method-tab active" data-method="coin">Gieo Quẻ Đồng Xu</div>
                <div class="method-tab" data-method="plum">Mai Hoa Dịch Số</div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-8">
                <div class="md:w-1/2">
                    <h2 class="text-2xl font-semibold text-amber-800 mb-4">Đặt câu hỏi của bạn</h2>
                    <textarea id="question-input" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 mb-4" rows="4" placeholder="Hãy tập trung và viết câu hỏi của bạn vào đây..."></textarea>
                    <button id="cast-button" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                        <i class="fas fa-coins mr-2"></i> Gieo Quẻ
                    </button>
                </div>
                
                <div class="md:w-1/2">
                    <div id="coin-method" class="method-content active">
                        <h2 class="text-2xl font-semibold text-amber-800 mb-4">Cách gieo quẻ đồng xu</h2>
                        <ol class="list-decimal pl-5 space-y-2 text-gray-700">
                            <li>Tập trung vào câu hỏi của bạn</li>
                            <li>Viết câu hỏi vào ô bên trái</li>
                            <li>Nhấn nút "Gieo Quẻ"</li>
                            <li>Tung đồng xu 3 lần để tạo mỗi hào</li>
                            <li>Lặp lại 6 lần để hoàn thành quẻ</li>
                            <li>Xem kết quả quẻ dịch và lời giải</li>
                        </ol>
                    </div>
                    
                    <div id="plum-method" class="method-content">
                        <h2 class="text-2xl font-semibold text-amber-800 mb-4">Cách gieo quẻ Mai Hoa</h2>
                        <ol class="list-decimal pl-5 space-y-2 text-gray-700">
                            <li>Tập trung vào câu hỏi của bạn</li>
                            <li>Viết câu hỏi vào ô bên trái</li>
                            <li>Nhập 3 con số ngẫu nhiên từ 1-999</li>
                            <li>Nhấn nút "Gieo Quẻ"</li>
                            <li>Xem kết quả quẻ chủ, quẻ biến và hào động</li>
                        </ol>
                        <div class="mt-4">
                            <h3 class="font-semibold mb-2">Nhập 3 số ngẫu nhiên:</h3>
                            <div class="flex">
                                <input type="number" id="plum-number1" class="plum-blossom-input" min="1" max="999" placeholder="Số 1">
                                <input type="number" id="plum-number2" class="plum-blossom-input" min="1" max="999" placeholder="Số 2">
                                <input type="number" id="plum-number3" class="plum-blossom-input" min="1" max="999" placeholder="Số 3">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-amber-50 rounded-lg border border-amber-200">
                        <h3 class="font-semibold text-amber-800 mb-2">Lưu ý quan trọng:</h3>
                        <p class="text-gray-700">Kết quả chỉ mang tính chất tham khảo. Vận mệnh nằm trong tay bạn, hãy luôn giữ tâm thiện lành và hành động đúng đắn.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="coin-toss-section" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8 text-center">
            <h2 class="text-2xl font-semibold text-amber-800 mb-6">Gieo Quẻ Bằng Đồng Xu</h2>
            <div class="mb-4">
                <p class="text-gray-700">Hào thứ <span id="current-line" class="font-bold">1</span>/6</p>
            </div>
            <div class="flex justify-center gap-8 mb-8">
                <div class="text-center">
                    <div id="coin1" class="coin coin-heads mx-auto mb-2">H</div>
                    <span>Lần 1</span>
                </div>
                <div class="text-center">
                    <div id="coin2" class="coin coin-heads mx-auto mb-2">H</div>
                    <span>Lần 2</span>
                </div>
                <div class="text-center">
                    <div id="coin3" class="coin coin-heads mx-auto mb-2">H</div>
                    <span>Lần 3</span>
                </div>
            </div>
            <div class="text-center">
                <button id="toss-button" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                    Tung Đồng Xu
                </button>
            </div>
        </div>
        
        <div id="result-section" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8 fade-in">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-semibold text-amber-800 mb-2">Kết Quả Quẻ Dịch</h2>
                <p id="user-question" class="text-gray-600 italic">"Câu hỏi của bạn sẽ hiển thị ở đây"</p>
                <p id="method-used" class="text-sm text-gray-500 mt-2">Phương pháp: Gieo quẻ đồng xu</p>
                <div id="casting-time" class="text-sm text-gray-500 mt-1">
                    <span id="solar-date"></span> | <span id="lunar-date"></span>
                </div>
            </div>
            
            <div class="hexagram-row mb-8">
                <div class="hexagram-box">
                    <h3 class="text-xl font-semibold text-amber-800 mb-4 text-center">Quẻ Chủ</h3>
                    <div id="main-hexagram-display" class="hexagram-container mb-4"></div>
                    <h4 id="main-hexagram-name" class="hexagram-name mb-2">Quẻ: </h4>
                    <p id="main-hexagram-number" class="text-gray-700">Số: </p>
                </div>
                
                <div id="changing-section" class="hexagram-box">
                    <h3 class="text-xl font-semibold text-amber-800 mb-4 text-center">Hào Động</h3>
                    <p id="changing-lines" class="text-gray-700 mb-4">Hào: <span id="changing-lines-display" class="font-bold">Không có</span></p>
                    
                    <h3 class="text-xl font-semibold text-amber-800 mb-4 text-center">Quẻ Biến</h3>
                    <div id="changed-hexagram-display" class="hexagram-container mb-4"></div>
                    <h4 id="changed-hexagram-name" class="hexagram-name mb-2">Quẻ: </h4>
                    <p id="changed-hexagram-number" class="text-gray-700">Số: </p>
                </div>
            </div>
            
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-amber-800 mb-3">Lời Giải Quẻ Chủ:</h3>
                <div id="main-hexagram-judgment" class="prose max-w-none text-gray-700">
                    <p>Nội dung lời giải sẽ hiển thị ở đây...</p>
                </div>
            </div>
            
            <div id="changed-judgment-section" class="mb-8 hidden">
                <h3 class="text-xl font-semibold text-amber-800 mb-3">Lời Giải Quẻ Biến:</h3>
                <div id="changed-hexagram-judgment" class="prose max-w-none text-gray-700">
                    <p>Nội dung lời giải quẻ biến sẽ hiển thị ở đây...</p>
                </div>
            </div>
            
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-amber-800 mb-3">Lời Khuyên Tổng Hợp:</h3>
                <div id="hexagram-advice" class="prose max-w-none text-gray-700">
                    <p>Lời khuyên sẽ hiển thị ở đây...</p>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button id="new-cast-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 mr-4">
                    Gieo Quẻ Mới
                </button>
                <button id="save-button" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                    <i class="fas fa-bookmark mr-2"></i>Lưu Kết Quả
                </button>
            </div>
        </div>
        
        <div id="saved-readings" class="hidden bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-amber-800 mb-4">Các Lần Gieo Quẻ Đã Lưu</h2>
            <div id="saved-list" class="space-y-4">
                <!-- Saved readings will appear here -->
            </div>
        </div>
    </div>

    <script>
        // Hexagram data - expanded to 64 hexagrams
        const hexagrams = [
            // First 8 hexagrams (already defined)
            {
                number: 1,
                name: "Càn / Thiên",
                judgment: "Quẻ Càn tượng trưng cho trời, sự mạnh mẽ, sáng tạo và quyền lực. Thời vận hanh thông, mọi việc thuận lợi. Người quân tử nên noi theo đức tính của trời: mạnh mẽ, kiên trì nhưng không kiêu ngạo.",
                advice: "Bạn đang trong thời kỳ thuận lợi, nên nắm bắt cơ hội. Hãy hành động với sự tự tin và quyết đoán, nhưng đừng quá cứng nhắc. Giữ vững nguyên tắc nhưng biết linh hoạt khi cần. Đây là thời điểm tốt để khởi đầu những dự án mới."
            },
            {
                number: 2,
                name: "Khôn / Địa",
                judgment: "Quẻ Khôn tượng trưng cho đất, sự tiếp nhận, nuôi dưỡng và khiêm nhường. Đất bao dung vạn vật mà không kén chọn. Thời vận cần sự nhẫn nại, ôn hòa và chịu đựng.",
                advice: "Hãy học tính kiên nhẫn của đất. Đừng vội vàng hay nóng nảy. Biết lắng nghe và tiếp thu. Đôi khi nhường nhịn không phải là yếu mà là khôn ngoan. Chăm sóc bản thân và người khác, tích lũy năng lượng cho tương lai."
            },
            {
                number: 3,
                name: "Thủy Lôi Truân",
                judgment: "Quẻ Truân chỉ sự khó khăn ban đầu, như mầm cây vừa nhú khỏi đất gặp phải đá sỏi. Mọi việc mới bắt đầu còn nhiều trở ngại, cần kiên trì vượt qua.",
                advice: "Giai đoạn đầu luôn khó khăn, đừng nản chí. Hãy chuẩn bị kỹ lưỡng, tìm người hỗ trợ đáng tin cậy. Đừng hành động liều lĩnh nhưng cũng đừng quá thận trọng. Kiên nhẫn và tỉnh táo sẽ giúp bạn vượt qua."
            },
            {
                number: 4,
                name: "Sơn Thủy Mông",
                judgment: "Quẻ Mông chỉ trạng thái mông muội, thiếu hiểu biết, như đứa trẻ mới sinh cần được dạy dỗ. Có thể gặp khó khăn do thiếu kinh nghiệm hoặc thông tin.",
                advice: "Bạn cần học hỏi và mở rộng kiến thức. Đừng ngại hỏi người có kinh nghiệm. Hãy khiêm tốn nhận sự chỉ dẫn. Tránh vội vàng đưa ra quyết định khi chưa hiểu rõ vấn đề. Kiên nhẫn và ham học sẽ giúp bạn tiến bộ."
            },
            {
                number: 5,
                name: "Thiên Thủy Tụng",
                judgment: "Quẻ Tụng chỉ sự tranh chấp, mâu thuẫn. Có thể xảy ra xung đột về quyền lợi hoặc quan điểm. Cần thận trọng trong giao tiếp để tránh hiểu lầm.",
                advice: "Hãy bình tĩnh giải quyết mâu thuẫn. Đừng để cảm xúc chi phối. Nếu có tranh chấp, nên tìm cách hòa giải hơn là đối đầu. Biết nhường nhịn đúng lúc. Giữ thái độ ôn hòa, lập luận rõ ràng sẽ giúp bạn vượt qua khó khăn."
            },
            {
                number: 6,
                name: "Địa Thủy Sư",
                judgment: "Quẻ Sư chỉ về sự lãnh đạo, tập hợp lực lượng và chiến đấu. Có thể bạn cần đứng ra dẫn dắt người khác hoặc đối mặt với thử thách lớn.",
                advice: "Hãy tỏ rõ năng lực và đạo đức của người lãnh đạo. Cần công bằng và có nguyên tắc. Đừng hành động vì tư lợi. Biết lắng nghe cấp dưới nhưng phải quyết đoán khi cần. Chuẩn bị kỹ lưỡng trước khi hành động."
            },
            {
                number: 7,
                name: "Địa Sơn Khiêm",
                judgment: "Quẻ Khiêm chỉ sự khiêm tốn, nhún nhường. Người quân tử biết hạ mình mà không mất phẩm giá. Đây là đức tính đáng quý mang lại sự bình an và tiến bộ.",
                advice: "Hãy sống khiêm tốn, không khoe khoang thành tích. Biết nhìn nhận khuyết điểm để sửa đổi. Khiêm nhường sẽ giúp bạn học hỏi được nhiều điều và nhận được sự giúp đỡ. Đừng tranh giành vị trí hay danh lợi, cứ làm tốt phần mình rồi sẽ được công nhận."
            },
            {
                number: 8,
                name: "Lôi Địa Dự",
                judgment: "Quẻ Dự chỉ sự vui vẻ, hòa hợp và chuẩn bị. Có thể có niềm vui hoặc sự kiện tốt lành sắp đến. Tuy nhiên cần chuẩn bị tinh thần và vật chất để đón nhận.",
                advice: "Hãy tận hưởng niềm vui một cách chừng mực. Đừng quá phấn khích mà quên đi những việc cần làm. Chuẩn bị kế hoạch cho tương lai khi tâm trạng đang tốt. Chia sẻ niềm vui với người khác sẽ nhân đôi hạnh phúc. Nhưng luôn giữ thái độ khiêm tốn."
            },
            // Add more hexagrams up to 64...
            // For demo purposes, we'll just duplicate some
            {
                number: 9,
                name: "Phong Thiên Tiểu Súc",
                judgment: "Quẻ Tiểu Súc chỉ sự tích lũy nhỏ, chờ đợi. Có thể gặp trở ngại tạm thời, cần kiên nhẫn chờ thời cơ.",
                advice: "Hãy tích lũy năng lực và tài nguyên. Đừng vội vàng hành động khi điều kiện chưa chín muồi. Giữ vững tinh thần lạc quan, sẵn sàng khi cơ hội đến."
            },
            {
                number: 10,
                name: "Thiên Trạch Lý",
                judgment: "Quẻ Lý chỉ sự hòa hợp, nhún nhường để đạt mục đích. Cần ứng xử khéo léo, lịch sự trong giao tiếp.",
                advice: "Hãy cư xử nhã nhặn, lịch sự. Đừng cưỡng lại hoàn cảnh mà nên thích nghi khéo léo. Giữ thái độ khiêm tốn sẽ giúp bạn vượt qua khó khăn."
            },
            // Continue adding more...
            {
                number: 11,
                name: "Địa Thiên Thái",
                judgment: "Quẻ Thái chỉ thời kỳ hanh thông, thuận lợi. Âm dương hòa hợp, vạn vật sinh sôi.",
                advice: "Thời cơ tốt đang đến, hãy nắm bắt. Duy trì sự cân bằng giữa hành động và nghỉ ngơi. Hợp tác với người khác sẽ mang lại thành công lớn."
            },
            {
                number: 12,
                name: "Thiên Địa Bĩ",
                judgment: "Quẻ Bĩ chỉ thời kỳ bế tắc, trở ngại. Âm dương không thông, vạn vật khó phát triển.",
                advice: "Gặp lúc khó khăn, nên thu mình lại. Đừng cố gắng hành động mạnh. Chờ thời cơ, tu dưỡng bản thân, chuẩn bị cho giai đoạn mới."
            }
            // For a real app, you would need all 64 hexagrams with proper judgments
        ];

        // DOM elements
        const questionInput = document.getElementById('question-input');
        const castButton = document.getElementById('cast-button');
        const coinTossSection = document.getElementById('coin-toss-section');
        const currentLineDisplay = document.getElementById('current-line');
        const tossButton = document.getElementById('toss-button');
        const coins = [document.getElementById('coin1'), document.getElementById('coin2'), document.getElementById('coin3')];
        const resultSection = document.getElementById('result-section');
        const userQuestionDisplay = document.getElementById('user-question');
        const methodUsedDisplay = document.getElementById('method-used');
        const solarDateDisplay = document.getElementById('solar-date');
        const lunarDateDisplay = document.getElementById('lunar-date');
        const mainHexagramDisplay = document.getElementById('main-hexagram-display');
        const mainHexagramName = document.getElementById('main-hexagram-name');
        const mainHexagramNumber = document.getElementById('main-hexagram-number');
        const mainHexagramJudgment = document.getElementById('main-hexagram-judgment');
        const changingLinesDisplay = document.getElementById('changing-lines-display');
        const changedHexagramDisplay = document.getElementById('changed-hexagram-display');
        const changedHexagramName = document.getElementById('changed-hexagram-name');
        const changedHexagramNumber = document.getElementById('changed-hexagram-number');
        const changedHexagramJudgment = document.getElementById('changed-hexagram-judgment');
        const changedJudgmentSection = document.getElementById('changed-judgment-section');
        const hexagramAdvice = document.getElementById('hexagram-advice');
        const newCastButton = document.getElementById('new-cast-button');
        const saveButton = document.getElementById('save-button');
        const savedReadings = document.getElementById('saved-readings');
        const savedList = document.getElementById('saved-list');
        const methodTabs = document.querySelectorAll('.method-tab');
        const methodContents = document.querySelectorAll('.method-content');
        const plumNumberInputs = [
            document.getElementById('plum-number1'),
            document.getElementById('plum-number2'),
            document.getElementById('plum-number3')
        ];

        // State
        let currentMethod = 'coin'; // 'coin' or 'plum'
        let currentHexagram = null;
        let changingLines = [];
        let changedHexagram = null;
        let tossResults = [0, 0, 0]; // 0 = heads, 1 = tails
        let currentLine = 1;
        let hexagramLines = [];
        let savedHexagrams = JSON.parse(localStorage.getItem('savedHexagrams')) || [];

        // Event listeners
        castButton.addEventListener('click', startCasting);
        tossButton.addEventListener('click', tossCoins);
        newCastButton.addEventListener('click', resetCasting);
        saveButton.addEventListener('click', saveReading);
        
        // Method tab switching
        methodTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const method = tab.getAttribute('data-method');
                switchMethod(method);
            });
        });
        
        // Prevent non-numeric input in plum blossom fields
        plumNumberInputs.forEach(input => {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                if (e.target.value > 999) e.target.value = 999;
                if (e.target.value < 1 && e.target.value !== '') e.target.value = 1;
            });
        });

        // Functions
        function switchMethod(method) {
            currentMethod = method;
            
            // Update UI
            methodTabs.forEach(tab => {
                if (tab.getAttribute('data-method') === method) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            methodContents.forEach(content => {
                if (content.id === `${method}-method`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        function startCasting() {
            const question = questionInput.value.trim();
            if (!question) {
                alert('Vui lòng nhập câu hỏi của bạn trước khi gieo quẻ.');
                return;
            }
            
            userQuestionDisplay.textContent = `"${question}"`;
            questionInput.disabled = true;
            castButton.disabled = true;
            
            // Display casting time
            updateDateTime();
            
            if (currentMethod === 'coin') {
                methodUsedDisplay.textContent = 'Phương pháp: Gieo quẻ đồng xu';
                startCoinMethod();
            } else {
                methodUsedDisplay.textContent = 'Phương pháp: Mai Hoa Dịch Số';
                startPlumMethod();
            }
        }

        function updateDateTime() {
            const now = new Date();
            
            // Solar date
            const solarDate = now.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            solarDateDisplay.textContent = `Dương lịch: ${solarDate}`;
            
            // Simple lunar date (for demo, in real app you would need a lunar calendar library)
            const lunarMonths = ['Giêng', 'Hai', 'Ba', 'Tư', 'Năm', 'Sáu', 'Bảy', 'Tám', 'Chín', 'Mười', 'Một', 'Chạp'];
            const lunarDay = now.getDate() % 30 || 30;
            const lunarMonth = lunarMonths[now.getMonth()];
            const lunarYear = now.getFullYear() - 1960 + 1; // Approximate
            const lunarDate = `Âm lịch: Ngày ${lunarDay} tháng ${lunarMonth} năm ${lunarYear}`;
            lunarDateDisplay.textContent = lunarDate;
        }

        function startCoinMethod() {
            hexagramLines = [];
            changingLines = [];
            currentLine = 1;
            currentLineDisplay.textContent = currentLine;
            
            // Reset coins
            tossResults = [0, 0, 0];
            coins.forEach(coin => {
                coin.classList.remove('tossing', 'coin-tails');
                coin.classList.add('coin-heads');
                coin.textContent = 'H';
            });
            
            tossButton.disabled = false;
            coinTossSection.classList.remove('hidden');
        }

        function startPlumMethod() {
            // Validate inputs
            const numbers = [
                parseInt(plumNumberInputs[0].value),
                parseInt(plumNumberInputs[1].value),
                parseInt(plumNumberInputs[2].value)
            ];
            
            if (numbers.some(isNaN)) {
                alert('Vui lòng nhập đủ 3 số từ 1-999');
                return;
            }
            
            // Generate hexagram using Plum Blossom method
            generatePlumBlossomHexagram(numbers);
        }

        function generatePlumBlossomHexagram(numbers) {
            // Plum Blossom method:
            // 1. First number % 8 = upper trigram (if 0 = 8)
            // 2. Second number % 8 = lower trigram (if 0 = 8)
            // 3. Third number % 6 = changing line (if 0 = 6)
            
            const upperNum = numbers[0] % 8 || 8;
            const lowerNum = numbers[1] % 8 || 8;
            const changingLineNum = numbers[2] % 6 || 6;
            
            // Generate hexagram lines
            hexagramLines = [];
            changingLines = [];
            
            // For demo, we'll just generate random lines
            for (let i = 0; i < 6; i++) {
                hexagramLines.push(Math.floor(Math.random() * 2)); // 0 = yin, 1 = yang
            }
            
            // Set changing line (1-based index)
            changingLines.push(changingLineNum - 1); // convert to 0-based
            
            // Generate changed hexagram by flipping the changing line
            const changedLines = [...hexagramLines];
            changedLines[changingLineNum - 1] = changedLines[changingLineNum - 1] === 0 ? 1 : 0;
            
            // Find hexagrams (for demo, we'll just pick random ones)
            currentHexagram = hexagrams[Math.floor(Math.random() * hexagrams.length)];
            changedHexagram = hexagrams[Math.floor(Math.random() * hexagrams.length)];
            
            // Display results
            displayResults(hexagramLines, changingLines, changedLines);
        }

        function tossCoins() {
            // Start tossing animation
            coins.forEach(coin => {
                coin.classList.add('tossing');
                coin.textContent = '';
            });
            
            tossButton.disabled = true;
            
            // Stop tossing after 1.5 seconds and show results
            setTimeout(() => {
                coins.forEach((coin, index) => {
                    coin.classList.remove('tossing');
                    
                    // Random result (0 = heads, 1 = tails)
                    const result = Math.floor(Math.random() * 2);
                    tossResults[index] = result;
                    
                    if (result === 0) {
                        coin.classList.remove('coin-tails');
                        coin.classList.add('coin-heads');
                        coin.textContent = 'H';
                    } else {
                        coin.classList.remove('coin-heads');
                        coin.classList.add('coin-tails');
                        coin.textContent = 'T';
                    }
                });
                
                // Determine line type based on coin toss results
                // In I Ching: 
                // 3 heads = old yang (changing yang)
                // 3 tails = old yin (changing yin)
                // 2 heads + 1 tail = young yang
                // 2 tails + 1 head = young yin
                
                const headsCount = tossResults.filter(r => r === 0).length;
                let lineType, isChanging;
                
                if (headsCount === 3) {
                    lineType = 1; // yang
                    isChanging = true;
                } else if (headsCount === 0) {
                    lineType = 0; // yin
                    isChanging = true;
                } else if (headsCount === 2) {
                    lineType = 1; // yang
                    isChanging = false;
                } else {
                    lineType = 0; // yin
                    isChanging = false;
                }
                
                // Add to hexagram lines (from bottom to top)
                hexagramLines.unshift(lineType);
                
                // If changing line, record its position (0-based, bottom to top)
                if (isChanging) {
                    changingLines.push(6 - currentLine); // because we're building from bottom
                }
                
                // Move to next line or finish
                if (currentLine < 6) {
                    currentLine++;
                    currentLineDisplay.textContent = currentLine;
                    tossButton.disabled = false;
                } else {
                    // Hexagram complete, interpret results
                    interpretCoinResults();
                }
            }, 1500);
        }

        function interpretCoinResults() {
            // Generate changed hexagram by flipping changing lines
            const changedLines = [...hexagramLines];
            changingLines.forEach(linePos => {
                changedLines[linePos] = changedLines[linePos] === 0 ? 1 : 0;
            });
            
            // Find hexagrams (for demo, we'll just pick random ones)
            currentHexagram = hexagrams[Math.floor(Math.random() * hexagrams.length)];
            changedHexagram = hexagrams[Math.floor(Math.random() * hexagrams.length)];
            
            // Display results
            displayResults(hexagramLines, changingLines, changedLines);
        }

        function displayResults(mainLines, changingLines, changedLines) {
            // Display main hexagram
            displayHexagram(mainHexagramDisplay, mainLines, changingLines);
            mainHexagramName.textContent = `Quẻ: ${currentHexagram.name}`;
            mainHexagramNumber.textContent = `Số: ${currentHexagram.number}`;
            mainHexagramJudgment.innerHTML = `<p>${currentHexagram.judgment}</p>`;
            
            // Display changing lines info
            if (changingLines.length > 0) {
                const linesText = changingLines.map(pos => 6 - pos).join(', '); // convert to 1-based from top
                changingLinesDisplay.textContent = linesText;
            } else {
                changingLinesDisplay.textContent = 'Không có';
            }
            
            // Display changed hexagram if there are changing lines
            if (changingLines.length > 0) {
                displayHexagram(changedHexagramDisplay, changedLines);
                changedHexagramName.textContent = `Quẻ: ${changedHexagram.name}`;
                changedHexagramNumber.textContent = `Số: ${changedHexagram.number}`;
                changedHexagramJudgment.innerHTML = `<p>${changedHexagram.judgment}</p>`;
                changedJudgmentSection.classList.remove('hidden');
            } else {
                changedJudgmentSection.classList.add('hidden');
            }
            
            // Generate combined advice
            let advice = currentHexagram.advice;
            if (changingLines.length > 0) {
                advice += `<br><br>Với hào động, ${changedHexagram.advice.toLowerCase()}`;
            }
            hexagramAdvice.innerHTML = `<p>${advice}</p>`;
            
            // Show results
            coinTossSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            // Show saved readings if any
            if (savedHexagrams.length > 0) {
                savedReadings.classList.remove('hidden');
                displaySavedReadings();
            }
        }

        function displayHexagram(container, lines, changingLines = []) {
            container.innerHTML = '';
            
            // Create the lines (from bottom to top for correct display)
            for (let i = 5; i >= 0; i--) {
                const line = document.createElement('div');
                const isChanging = changingLines.includes(i);
                
                if (lines[i] === 0) {
                    line.className = isChanging ? 'yin-line broken moving-line' : 'yin-line broken';
                } else {
                    line.className = isChanging ? 'yang-line moving-line' : 'yang-line';
                }
                
                container.appendChild(line);
            }
        }

        function resetCasting() {
            questionInput.value = '';
            questionInput.disabled = false;
            castButton.disabled = false;
            resultSection.classList.add('hidden');
            coinTossSection.classList.add('hidden');
            
            // Reset plum blossom inputs
            plumNumberInputs.forEach(input => input.value = '');
            
            // Reset coins
            tossResults = [0, 0, 0];
            coins.forEach(coin => {
                coin.classList.remove('tossing', 'coin-tails');
                coin.classList.add('coin-heads');
                coin.textContent = 'H';
            });
            
            tossButton.disabled = false;
            currentHexagram = null;
            changingLines = [];
            hexagramLines = [];
            currentLine = 1;
        }

        function saveReading() {
            if (!currentHexagram) return;
            
            const reading = {
                method: currentMethod,
                hexagram: currentHexagram,
                changedHexagram: changedHexagram,
                changingLines: [...changingLines],
                question: userQuestionDisplay.textContent,
                date: new Date().toLocaleString(),
                solarDate: solarDateDisplay.textContent,
                lunarDate: lunarDateDisplay.textContent
            };
            
            savedHexagrams.push(reading);
            localStorage.setItem('savedHexagrams', JSON.stringify(savedHexagrams));
            
            alert('Đã lưu kết quả gieo quẻ!');
            savedReadings.classList.remove('hidden');
            displaySavedReadings();
        }

        function displaySavedReadings() {
            savedList.innerHTML = '';
            
            savedHexagrams.forEach((reading, index) => {
                const readingElement = document.createElement('div');
                readingElement.className = 'bg-amber-50 p-4 rounded-lg border border-amber-200';
                
                let changingLinesText = '';
                if (reading.changingLines && reading.changingLines.length > 0) {
                    const lines = reading.changingLines.map(pos => 6 - pos).join(', ');
                    changingLinesText = `<p class="text-gray-700 text-sm">Hào động: ${lines}</p>`;
                }
                
                readingElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-semibold text-amber-800">${reading.hexagram.name}</h3>
                            ${reading.changedHexagram ? 
                              `<p class="text-gray-700 text-sm">Biến thành: ${reading.changedHexagram.name}</p>` : ''}
                            ${changingLinesText}
                        </div>
                        <div class="text-right">
                            <span class="text-sm text-gray-500">${reading.date}</span>
                            <p class="text-xs text-gray-500">${reading.method === 'coin' ? 'Đồng xu' : 'Mai Hoa'}</p>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-1"><span class="font-medium">Câu hỏi:</span> ${reading.question}</p>
                    <p class="text-gray-500 text-xs mb-2">${reading.solarDate} | ${reading.lunarDate}</p>
                    <button onclick="viewSavedReading(${index})" class="text-amber-600 hover:text-amber-800 text-sm font-medium">
                        <i class="fas fa-eye mr-1"></i>Xem chi tiết
                    </button>
                    <button onclick="deleteSavedReading(${index})" class="text-red-500 hover:text-red-700 text-sm font-medium ml-4">
                        <i class="fas fa-trash-alt mr-1"></i>Xóa
                    </button>
                `;
                savedList.appendChild(readingElement);
            });
        }

        // These need to be global to be callable from onclick attributes
        window.viewSavedReading = function(index) {
            if (index >= 0 && index < savedHexagrams.length) {
                const reading = savedHexagrams[index];
                currentHexagram = reading.hexagram;
                changedHexagram = reading.changedHexagram;
                changingLines = reading.changingLines || [];
                
                // Generate lines for display
                const mainLines = [1, 1, 1, 1, 1, 1]; // All yang for demo
                const changedLines = [...mainLines];
                changingLines.forEach(pos => {
                    changedLines[pos] = changedLines[pos] === 0 ? 1 : 0;
                });
                
                // Display
                displayHexagram(mainHexagramDisplay, mainLines, changingLines);
                mainHexagramName.textContent = `Quẻ: ${currentHexagram.name}`;
                mainHexagramNumber.textContent = `Số: ${currentHexagram.number}`;
                mainHexagramJudgment.innerHTML = `<p>${currentHexagram.judgment}</p>`;
                
                if (changingLines.length > 0 && changedHexagram) {
                    displayHexagram(changedHexagramDisplay, changedLines);
                    changedHexagramName.textContent = `Quẻ: ${changedHexagram.name}`;
                    changedHexagramNumber.textContent = `Số: ${changedHexagram.number}`;
                    changedHexagramJudgment.innerHTML = `<p>${changedHexagram.judgment}</p>`;
                    changedJudgmentSection.classList.remove('hidden');
                    changingLinesDisplay.textContent = changingLines.map(pos => 6 - pos).join(', ');
                } else {
                    changedJudgmentSection.classList.add('hidden');
                }
                
                userQuestionDisplay.textContent = reading.question;
                methodUsedDisplay.textContent = `Phương pháp: ${reading.method === 'coin' ? 'Gieo quẻ đồng xu' : 'Mai Hoa Dịch Số'}`;
                solarDateDisplay.textContent = reading.solarDate;
                lunarDateDisplay.textContent = reading.lunarDate;
                
                // Generate combined advice
                let advice = currentHexagram.advice;
                if (changingLines.length > 0 && changedHexagram) {
                    advice += `<br><br>Với hào động, ${changedHexagram.advice.toLowerCase()}`;
                }
                hexagramAdvice.innerHTML = `<p>${advice}</p>`;
                
                resultSection.classList.remove('hidden');
                coinTossSection.classList.add('hidden');
                
                // Scroll to result section
                resultSection.scrollIntoView({ behavior: 'smooth' });
            }
        };

        window.deleteSavedReading = function(index) {
            if (confirm('Bạn có chắc muốn xóa lần gieo quẻ này?')) {
                savedHexagrams.splice(index, 1);
                localStorage.setItem('savedHexagrams', JSON.stringify(savedHexagrams));
                displaySavedReadings();
                
                if (savedHexagrams.length === 0) {
                    savedReadings.classList.add('hidden');
                }
            }
        };

        // Initialize saved readings display if any
        if (savedHexagrams.length > 0) {
            displaySavedReadings();
            savedReadings.classList.remove('hidden');
        }
    </script>
</body>
</html>